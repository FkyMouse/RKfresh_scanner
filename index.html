<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>EAN13 Scanner PRO</title>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
    margin:0;
    background:#000;
    color:#fff;
    font-family:system-ui;
    overflow:hidden;
}

#reader{
    position:fixed;
    inset:0;
}

#status{
    position:fixed;
    top:15px;
    left:10px;
    right:10px;
    text-align:center;
    padding:14px;
    border-radius:16px;
    background:rgba(0,0,0,.65);
    backdrop-filter:blur(6px);
    font-size:17px;
    z-index:10;
}

#controls{
    position:fixed;
    bottom:30px;
    width:100%;
    display:flex;
    justify-content:center;
    gap:12px;
    z-index:10;
}

button{
    padding:14px 22px;
    border:none;
    border-radius:14px;
    font-size:16px;
    background:#444;
    color:white;
}

.flash{
    position:fixed;
    inset:0;
    background:#00c853;
    opacity:0;
    pointer-events:none;
}

.flash.active{
    animation:flash .5s;
}

@keyframes flash{
    from{opacity:.85}
    to{opacity:0}
}
</style>
</head>
<body>

<div id="reader"></div>
<div id="status">Запуск камеры…</div>

<div id="controls">
<button id="photoBtn">Фото</button>
<button id="torchBtn">Фонарик</button>
</div>

<div class="flash" id="flash"></div>

<input type="file" accept="image/*" capture="environment" id="fileInput" hidden>

<script>
const tg=window.Telegram.WebApp;
tg.ready(); tg.expand();

const reader=new Html5Qrcode("reader");
const statusEl=document.getElementById("status");

let scanning=true;
let locked=false;

// ---------- старт камеры ----------
async function start(){
await reader.start(
{facingMode:"environment"},
{fps:12, qrbox:{width:300,height:160}},
detectCandidate);
statusEl.innerText="Наведите камеру";
}

// ---------- быстрый детектор ----------
function detectCandidate(text,result){
if(locked) return;
if(!result.resultPoints) return;

// найден кандидат — делаем HD snapshot
captureAndDecode();
}

// ---------- делаем снимок ----------
async function captureAndDecode(){
locked=true;
statusEl.innerText="Сканирую…";

const track=reader.getRunningTrack();
const imageCapture=new ImageCapture(track);
const bitmap=await imageCapture.grabFrame();

const canvas=document.createElement("canvas");
canvas.width=bitmap.width;
canvas.height=bitmap.height;
const ctx=canvas.getContext("2d");
ctx.drawImage(bitmap,0,0);

// ---------- улучшение изображения ----------
let img=ctx.getImageData(0,0,canvas.width,canvas.height);
let d=img.data;

for(let i=0;i<d.length;i+=4){
let gray=d[i]*0.3+d[i+1]*0.59+d[i+2]*0.11;

// контраст
gray=gray>140?255:0;

d[i]=d[i+1]=d[i+2]=gray;
}
ctx.putImageData(img,0,0);

// ---------- decode улучшенного кадра ----------
try{
const res=await reader.scanFile(
await new Promise(r=>canvas.toBlob(r,"image/png")),
true);

success(res.decodedText);
}
catch{
locked=false;
statusEl.innerText="Не удалось. Наведите снова";
}
}

// ---------- успех ----------
async function success(code){
await reader.stop();
statusEl.innerText="Код: "+code;

tg.MainButton.setText("Отправить "+code);
tg.MainButton.show();
window.result=code;
}

// ---------- отправка ----------
tg.MainButton.onClick(()=>{
tg.sendData(window.result);
tg.close();
});
tg.MainButton.hide();

start();
</script>


</body>
</html>



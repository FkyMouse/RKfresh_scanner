<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>EAN13 Scanner PRO</title>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
    margin:0;
    background:#000;
    color:#fff;
    font-family:system-ui;
    overflow:hidden;
}

#reader{
    position:fixed;
    inset:0;
}

#status{
    position:fixed;
    top:15px;
    left:10px;
    right:10px;
    text-align:center;
    padding:14px;
    border-radius:16px;
    background:rgba(0,0,0,.65);
    backdrop-filter:blur(6px);
    font-size:17px;
    z-index:10;
}

#controls{
    position:fixed;
    bottom:30px;
    width:100%;
    display:flex;
    justify-content:center;
    gap:12px;
    z-index:10;
}

button{
    padding:14px 22px;
    border:none;
    border-radius:14px;
    font-size:16px;
    background:#444;
    color:white;
}

.flash{
    position:fixed;
    inset:0;
    background:#00c853;
    opacity:0;
    pointer-events:none;
}

.flash.active{
    animation:flash .5s;
}

@keyframes flash{
    from{opacity:.85}
    to{opacity:0}
}
</style>
</head>
<body>

<div id="reader"></div>
<div id="status">Запуск камеры…</div>

<div id="controls">
<button id="photoBtn">Фото</button>
<button id="torchBtn">Фонарик</button>
</div>

<div class="flash" id="flash"></div>

<input type="file" accept="image/*" capture="environment" id="fileInput" hidden>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();
tg.enableClosingConfirmation();

const reader = new Html5Qrcode("reader");
const statusEl = document.getElementById("status");
const flash = document.getElementById("flash");

let locked=false;
let torchOn=false;

// ---------- запуск камеры высокого качества ----------
async function startScanner(){
    try{

        await reader.start(
            {
                facingMode:"environment",
                width:{ ideal:1920 },
                height:{ ideal:1080 }
            },
            {
                fps:10, // ниже fps = выше точность
                qrbox:{ width:420, height:220 }, // большой скан-бокс
                aspectRatio:1.8,
                disableFlip:true,
                experimentalFeatures:{
                    useBarCodeDetectorIfSupported:true
                },
                formatsToSupport:[
                    Html5QrcodeSupportedFormats.EAN_13
                ]
            },
            onScan
        );

        statusEl.innerText="Наведите камеру на штрих-код";

        enableCameraEnhancements();

    }catch(e){
        console.log(e);
        statusEl.innerText="Нет доступа к камере. Используйте фото.";
    }
}

// ---------- улучшения камеры ----------
async function enableCameraEnhancements(){
    try{
        const track = reader.getRunningTrack();
        const caps = track.getCapabilities();

        let settings={};

        if(caps.focusMode)
            settings.focusMode="continuous";

        if(caps.zoom)
            settings.zoom=Math.min(2, caps.zoom.max);

        await track.applyConstraints({ advanced:[settings] });
    }catch(e){
        console.log("enhance fail",e);
    }
}

// ---------- скан найден ----------
async function onScan(text){
    if(locked) return;
    locked=true;

    try{ await reader.stop(); }catch{}

    flash.classList.add("active");
    setTimeout(()=>flash.classList.remove("active"),500);

    statusEl.innerText="Найден код: "+text;

    tg.MainButton.setText("Отправить: "+text);
    tg.MainButton.show();

    window.result=text;
}

// ---------- отправка ----------
tg.MainButton.onClick(()=>{
    if(window.result){
        tg.sendData(window.result);
        tg.close();
    }
});
tg.MainButton.hide();

// ---------- фото fallback ----------
document.getElementById("photoBtn").onclick=async()=>{
    try{ await reader.stop(); }catch{}
    document.getElementById("fileInput").click();
};

document.getElementById("fileInput").onchange=async e=>{
    const file=e.target.files[0];
    if(!file) return;

    statusEl.innerText="Распознаю фото...";
    try{
        const res=await reader.scanFile(file,true);
        onScan(res.decodedText);
    }
    catch{
        statusEl.innerText="Код не найден. Попробуйте другое фото.";
        locked=false;
    }
};

// ---------- фонарик ----------
document.getElementById("torchBtn").onclick=async()=>{
    try{
        const track = reader.getRunningTrack();
        torchOn=!torchOn;
        await track.applyConstraints({
            advanced:[{ torch: torchOn }]
        });
    }catch{
        statusEl.innerText="Фонарик не поддерживается";
    }
};

// ---------- старт ----------
setTimeout(startScanner,300);
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Сканер штрих-кода / QR</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background: #000;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #reader {
            width: 100%;
            height: 100%;
            flex: 1;
        }
        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }
        #status {
            position: absolute;
            top: 20px;
            left: 10px;
            right: 10px;
            text-align: center;
            padding: 12px 16px;
            background: rgba(0,0,0,0.65);
            border-radius: 12px;
            font-size: 16px;
            z-index: 20;
            backdrop-filter: blur(4px);
        }
        #controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 16px;
            z-index: 20;
            flex-wrap: wrap;
        }
        button {
            padding: 16px 32px;
            font-size: 18px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            touch-action: manipulation;
            min-width: 140px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button.torch-active {
            background: #ff9500;
        }
    </style>
</head>
<body>

    <div id="reader"></div>
    <div id="status">Открытие камеры...</div>
    <div id="controls">
        <button id="galleryBtn">Из галереи</button>
        <button id="torchBtn">Фонарик вкл</button>
        <button id="stopBtn" style="display:none;">Остановить</button>
        <button id="restartBtn" style="display:none;">Запустить заново</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const html5QrCode = new Html5Qrcode("reader");
        const status = document.getElementById("status");
        let scanning = false;
        let torchSupported = false;
        let torchOn = false;

        const config = {
            fps: 12,
            qrbox: { width: 280, height: 280 },
            aspectRatio: window.innerWidth / window.innerHeight,
            disableFlip: false,
            experimentalFeatures: { useBarCodeDetectorIfSupported: true },
            formatsToSupport: [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39
            ]
        };

        function onScanSuccess(decodedText, decodedResult) {
            status.innerText = `Найден: ${decodedText}`;
            tg.MainButton.setText(`Отправить: ${decodedText}`);
            tg.MainButton.show();
            window.scannedCode = decodedText;
            stopScanning();
        }

        function onScanFailure(errorMessage) {
            if (errorMessage?.includes?.("No MultiFormat Readers")) return;
        }

        async function getBestBackCamera() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                if (videoDevices.length === 0) return null;

                const backCameras = videoDevices.filter(d =>
                    !d.label.toLowerCase().includes('front')
                );

                backCameras.sort((a, b) => {
                    const getScore = label => {
                        let score = 0;
                        if (/0|main|back|rear/i.test(label)) score += 10;
                        return score;
                    };
                    return getScore(b.label) - getScore(a.label);
                });

                return backCameras[0]?.deviceId || null;
            } catch (err) {
                console.error("Ошибка получения камер:", err);
                return null;
            }
        }

        async function startScanning() {
            status.innerText = "Запускаем камеру...";

            let constraints = { facingMode: { ideal: "environment" } };
            const deviceId = await getBestBackCamera();
            if (deviceId) constraints = { deviceId: { exact: deviceId } };

            try {
                await html5QrCode.start(constraints, config, onScanSuccess, onScanFailure);
                scanning = true;
                status.innerText = "Наведите на код";
                document.getElementById("stopBtn").style.display = "block";
                document.getElementById("restartBtn").style.display = "none";

                // Проверка поддержки фонарика (без включения)
                try {
                    await html5QrCode.applyVideoConstraints({ advanced: [{ torch: false }] });
                    torchSupported = true;
                    document.getElementById("torchBtn").style.display = "block";
                    document.getElementById("torchBtn").innerText = "Фонарик вкл";
                    document.getElementById("torchBtn").classList.remove("torch-active");
                } catch (e) {
                    torchSupported = false;
                    document.getElementById("torchBtn").style.display = "none";
                }

            } catch (err) {
                console.error("Ошибка запуска:", err);
                status.innerText = "Камера не открылась → используйте галерею";
            }
        }

        function stopScanning() {
            if (scanning) {
                html5QrCode.stop().then(() => {
                    scanning = false;
                    if (torchOn) {
                        html5QrCode.applyVideoConstraints({ advanced: [{ torch: false }] }).catch(() => {});
                        torchOn = false;
                        document.getElementById("torchBtn").innerText = "Фонарик вкл";
                        document.getElementById("torchBtn").classList.remove("torch-active");
                    }
                    status.innerText = "Сканирование остановлено";
                    document.getElementById("stopBtn").style.display = "none";
                    document.getElementById("restartBtn").style.display = "block";
                    html5QrCode.clear();
                }).catch(err => console.error("Ошибка остановки:", err));
            }
        }

        // ─── Кнопки ──────────────────────────────────────────────────

        document.getElementById("galleryBtn").onclick = async () => {
            stopScanning();
            status.innerText = "Выберите фото";
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.click();
            input.onchange = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                try {
                    const result = await html5QrCode.scanFile(file, true);
                    onScanSuccess(result.decodedText, result);
                } catch (err) {
                    status.innerText = "Не распознан код на фото";
                }
            };
        };

        document.getElementById("stopBtn").onclick = stopScanning;

        document.getElementById("restartBtn").onclick = startScanning;

        document.getElementById("torchBtn").onclick = async () => {
            if (!torchSupported || scanning === false) return;
            torchOn = !torchOn;
            try {
                await html5QrCode.applyVideoConstraints({ advanced: [{ torch: torchOn }] });
                document.getElementById("torchBtn").innerText = torchOn ? "Фонарик выкл" : "Фонарик вкл";
                document.getElementById("torchBtn").classList.toggle("torch-active", torchOn);
            } catch (err) {
                status.innerText = "Фонарик не работает";
                console.error(err);
            }
        };

        // Запуск при загрузке страницы
        startScanning();

        tg.MainButton.onClick(() => {
            if (window.scannedCode) {
                tg.sendData(window.scannedCode);
                tg.close();
            }
        });
    </script>
</body>
</html>
